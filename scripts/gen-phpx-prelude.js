const fs = require('fs');
const path = require('path');

const root = path.resolve(__dirname, '..');
const stdlibPath = path.join(root, 'php_modules', 'stdlib.json');
const modulesDir = path.join(root, 'php_modules');

const entries = JSON.parse(fs.readFileSync(stdlibPath, 'utf8'));
const specs = new Set();

for (const entry of entries) {
  if (entry.endsWith('/*')) {
    const prefix = entry.slice(0, -2);
    const dir = path.join(modulesDir, prefix);
    const items = fs.readdirSync(dir, { withFileTypes: true });
    for (const item of items) {
      if (!item.isFile()) continue;
      const ext = path.extname(item.name);
      if (ext !== '.phpx' && ext !== '.php') continue;
      const stem = path.basename(item.name, ext);
      const spec = `${prefix}/${stem}`;
      if (spec === 'core/prelude') continue;
      specs.add(spec);
    }
  } else {
    specs.add(entry);
  }
}

const sorted = Array.from(specs).sort();

const imports = [];
const binds = [];
for (let i = 0; i < sorted.length; i += 1) {
  const spec = sorted[i];
  const name = `__deka_mod_${i}`;
  imports.push(`import * as ${name} from '${spec}';`);
  binds.push(name);
}

const lines = [];
lines.push('// Generated by scripts/gen-phpx-prelude.js');
lines.push(...imports);
lines.push('');
lines.push('const __dekaExportToGlobal = (mod) => {');
lines.push('  if (!mod) return;');
lines.push('  for (const [key, value] of Object.entries(mod)) {');
lines.push('    if (key === "default" || key === "__esModule") {');
lines.push('      continue;');
lines.push('    }');
lines.push('    globalThis[key] = value;');
lines.push('  }');
lines.push('};');
lines.push('');
lines.push('export function install_globals() {');
lines.push('  if (globalThis.__dekaGlobalsInstalled === true) {');
lines.push('    return;');
lines.push('  }');
lines.push('  globalThis.__dekaGlobalsInstalled = true;');
lines.push('  if (!globalThis.panic) {');
lines.push('    globalThis.panic = (msg) => { throw new Error(String(msg)); };');
lines.push('  }');
for (const name of binds) {
  lines.push(`  __dekaExportToGlobal(${name});`);
}
lines.push('}');
lines.push('');

const outPath = path.join(root, 'php_modules', 'core', 'prelude.js');
fs.writeFileSync(outPath, lines.join('\n'));
console.log(`wrote ${outPath}`);
