/*
TEST: postgres wire-only smoke (fallback_native=false) supports parameterized query
*/
import { connect, query_one, close } from 'db/postgres'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$cfg = {
    host: getenv('DB_HOST') ?: '127.0.0.1',
    port: intval(getenv('DB_PORT') ?: '55432'),
    database: getenv('DB_NAME') ?: 'linkhash_registry',
    user: getenv('DB_USER') ?: 'postgres',
    password: getenv('DB_PASSWORD') ?: 'postgres',
    fallback_native: false
}

$conn = connect($cfg)
if (!result_is_ok($conn)) {
    echo "ERR connect\n"
    return
}

$res = query_one($conn->value, 'select $1::int + $2::int as s', [4, 5])
close($conn->value)
if (!result_is_ok($res)) {
    echo "ERR query\n"
    return
}

echo "OK " . $res->value['s'] . "\n"
