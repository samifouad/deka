/*
TEST: db facade contract for mysql wrapper (connect/query/query_one/close)
*/
import { connect, query, query_one, close } from 'db/mysql'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$host = getenv('MYSQL_HOST') ?: '127.0.0.1'
$port = intval(getenv('MYSQL_PORT') ?: '3306')
$database = getenv('MYSQL_DB') ?: 'test'
$user = getenv('MYSQL_USER') ?: 'root'
$password = getenv('MYSQL_PASSWORD') ?: ''

$conn = connect({ host: $host, port: $port, database: $database, user: $user, password: $password })
if (!result_is_ok($conn)) {
    echo "ERR connect\n"
    return
}

$h = $conn->value
$many = query($h, 'select 1 as c', [])
$one = query_one($h, 'select ? + ? as c', [1, 0])
close($h)

if (!result_is_ok($many) || !result_is_ok($one)) {
    echo "ERR query\n"
    return
}

echo "OK mysql " . $one->value['c'] . "\n"
