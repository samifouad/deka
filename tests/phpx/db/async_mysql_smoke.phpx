/*
TEST: Async MySQL smoke test for PHPX mysql module.
Mode:
- Default: prints SKIP unless PHPX_DB_SMOKE=1.
- Smoke: when enabled and MySQL is reachable, uses async default APIs.
*/
import { connect, query, close } from 'db/mysql'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$host = getenv('MYSQL_HOST') ?: '127.0.0.1'
$port = (int) (getenv('MYSQL_PORT') ?: '3306')
$database = getenv('MYSQL_DB') ?: 'test'
$user = getenv('MYSQL_USER') ?: 'root'
$password = getenv('MYSQL_PASSWORD') ?: ''

$conn = await connect({
    host: $host,
    port: $port,
    database: $database,
    user: $user,
    password: $password
})

if (!result_is_ok($conn)) {
    echo "ERR connect\n"
    return
}

$rows = await query($conn->value, 'select 1 as c', [])
await close($conn->value)

if (!result_is_ok($rows)) {
    echo "ERR query\n"
    return
}

$count = 0
if (is_array($rows->value) && array_key_exists('rows', $rows->value) && count($rows->value['rows']) > 0) {
    $first = $rows->value['rows'][0]
    if (is_array($first) && array_key_exists('c', $first)) {
        $count = (int) $first['c']
    }
}

echo "OK " . $count . "\n"
