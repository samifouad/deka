/*
TEST: mysql wire mode hard-errors unsupported parameter types (no native fallback for type errors)
*/
import { connectSync, query_one, closeSync } from 'db/mysql'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$cfg = {
    host: getenv('MYSQL_HOST') ?: '127.0.0.1',
    port: intval(getenv('MYSQL_PORT') ?: '3306'),
    database: getenv('MYSQL_DB') ?: 'test',
    user: getenv('MYSQL_USER') ?: 'root',
    password: getenv('MYSQL_PASSWORD') ?: '',
    fallback_native: false
}

$conn = connectSync($cfg)
if (!result_is_ok($conn)) {
    echo "ERR connectSync\n"
    return
}

$res = query_one($conn->value, 'select ? as v', [{ a: 1 }])
closeSync($conn->value)

if (result_is_ok($res)) {
    echo "ERR expected\n"
    return
}

echo "OK " . $res->error . "\n"
