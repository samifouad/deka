/*
TEST: PostgreSQL smoke test for PHPX postgres module.
Mode:
- Default: prints SKIP unless PHPX_DB_SMOKE=1.
- Smoke: when enabled, connects to local Docker Postgres and runs a simple query.
*/
import { pg_connect, pg_query, pg_close } from 'postgres';
import { result_is_ok } from 'core/result';

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n";
    return;
}

$host = getenv('DB_HOST') ?: '127.0.0.1';
$port = intval(getenv('DB_PORT') ?: '55432');
$database = getenv('DB_NAME') ?: 'linkhash_registry';
$user = getenv('DB_USER') ?: 'postgres';
$password = getenv('DB_PASSWORD') ?: 'postgres';

$conn = pg_connect({
    host: $host,
    port: $port,
    database: $database,
    user: $user,
    password: $password
});

if (!result_is_ok($conn)) {
    echo "ERR connect\n";
    return;
}

$rows = pg_query($conn->value, 'select count(*) as c from packages', []);
pg_close($conn->value);

if (!result_is_ok($rows)) {
    echo "ERR query\n";
    return;
}

$count = 0;
if (is_array($rows->value) && array_key_exists('rows', $rows->value) && count($rows->value['rows']) > 0) {
    $first = $rows->value['rows'][0];
    if (is_array($first) && array_key_exists('c', $first)) {
        $count = intval($first['c']);
    }
}

echo "OK " . $count . "\n";
