/*
TEST: framework context helpers
Covers: request context storage, auth/requireAuth/requireScope, and auth snapshot.
*/

import { result_is_ok } from 'core/result'
import { set_request_context, clear_request_context, auth, requireAuth, requireScope, auth_snapshot } from 'framework/context'

clear_request_context()
$a0 = auth()
echo (!result_is_ok($a0) ? 'auth-missing-ok' : 'auth-missing-bad') . "\n"

set_request_context({
  auth: {
    user_id: 'u_123',
    handle: '@sami',
    scopes: ['read', 'read:write'],
    org_id: 'org_1',
    token: 'secret-token'
  }
})

$a1 = auth()
echo (result_is_ok($a1) ? 'auth-ok' : 'auth-bad') . "\n"

$r1 = requireAuth()
echo (result_is_ok($r1) ? 'require-auth-ok' : 'require-auth-bad') . "\n"

$s1 = requireScope('read:write')
echo (result_is_ok($s1) ? 'scope-ok' : 'scope-bad') . "\n"

$s2 = requireScope('read:write:delete')
echo (!result_is_ok($s2) ? 'scope-deny-ok' : 'scope-deny-bad') . "\n"

$snap = auth_snapshot($a1->value)
$has_user = is_array($snap) && array_key_exists('user_id', $snap)
$has_token = is_array($snap) && array_key_exists('token', $snap)
echo ($has_user && !$has_token ? 'snapshot-ok' : 'snapshot-bad') . "\n"
