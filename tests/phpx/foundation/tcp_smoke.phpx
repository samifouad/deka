/*
TEST: tcp module can connect/write/read against a local test socket
*/
import { connect, write, read_exact, close } from 'tcp'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_NET_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$host = getenv('NET_HOST') ?: '127.0.0.1'
$port = intval(getenv('NET_PORT') ?: '0')
if ($port <= 0) {
    echo "SKIP\n"
    return
}

$conn = connect($host, $port, { timeout_ms: 3000 })
if (!result_is_ok($conn)) {
    echo "ERR connect\n"
    return
}

$h = $conn->value
$w = write($h, "ping\n")
if (!result_is_ok($w)) {
    close($h)
    echo "ERR write\n"
    return
}

$r = read_exact($h, 5)
close($h)
if (!result_is_ok($r)) {
    echo "ERR read\n"
    return
}

echo "OK " . $r->value
