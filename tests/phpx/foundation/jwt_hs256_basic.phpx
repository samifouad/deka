/*
TEST: jwt module signs and verifies HS256 tokens
Covers: sign(), verify(), iss/aud validation, payload roundtrip.
*/

import { sign, verify } from 'jwt'
import { result_is_ok } from 'core/result'

$signed = sign([ 'sub' => 'sam', 'role' => 'publisher' ], 'secret-key', [
  'iss' => 'linkhash',
  'aud' => 'deka',
  'exp_in' => 120
])

if (!result_is_ok($signed)) {
  echo 'sign_err:' . $signed->error . "\n"
  return
}

$token = $signed->value
$verified = verify($token, 'secret-key', [ 'iss' => 'linkhash', 'aud' => 'deka' ])

if (!result_is_ok($verified)) {
  echo 'verify_err:' . $verified->error . "\n"
  return
}

$claims = $verified->value
echo 'ok:' . $claims['sub'] . ':' . $claims['role'] . "\n"
