import { openHandleSync, queryOneSync, closeSync, statsSync } from 'db'
import { result_is_ok } from 'core/result'

$open = openHandleSync('sqlite', { path: '/tmp/deka_metrics_dump.sqlite' })
if (!result_is_ok($open)) {
  echo "ERR open\n"
  return
}
$h = $open->value
$one = queryOneSync($h, 'select 1 as one', [])
if (!result_is_ok($one)) {
  closeSync($h)
  echo "ERR query\n"
  return
}
$stats = statsSync()
closeSync($h)
if (!result_is_ok($stats)) {
  echo "ERR stats\n"
  return
}
$active = $stats->value['active_handles']
$drivers = $stats->value['handles_by_driver']
$metrics = $stats->value['metrics']
$cacheEntries = array_key_exists('statement_cache_entries', $stats->value) ? $stats->value['statement_cache_entries'] : -1
$cacheHits = array_key_exists('statement_cache_hits', $stats->value) ? $stats->value['statement_cache_hits'] : -1
$cacheMisses = array_key_exists('statement_cache_misses', $stats->value) ? $stats->value['statement_cache_misses'] : -1
echo "active=" . $active . " cache=" . $cacheEntries . "/" . $cacheHits . "/" . $cacheMisses . "\n"
echo json_encode($drivers) . "\n"
echo json_encode($metrics) . "\n"
