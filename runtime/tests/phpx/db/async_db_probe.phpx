/*
TEST: async DB probe without env gating.
*/
import { connect, exec, query, close } from 'db/sqlite'
import { result_is_ok } from 'core/result'

$conn = await connect({ path: '/tmp/deka_async_db_probe.sqlite' })
if (!result_is_ok($conn)) {
  echo "ERR connect\n"
  return
}

$h = $conn->value
$create = await exec($h, 'create table if not exists probe_items(id integer primary key, name text)', [])
if (!result_is_ok($create)) {
  await close($h)
  echo "ERR exec\n"
  return
}

$insert = await exec($h, 'insert into probe_items(name) values (?)', ['x'])
if (!result_is_ok($insert)) {
  await close($h)
  echo "ERR exec\n"
  return
}

$rows = await query($h, 'select count(*) as c from probe_items', [])
await close($h)

if (!result_is_ok($rows)) {
  echo "ERR query\n"
  return
}

$first = $rows->value['rows'][0]
echo "OK db " . (int) $first['c'] . "\n"
