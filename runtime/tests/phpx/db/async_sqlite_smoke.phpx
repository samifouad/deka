/*
TEST: Async SQLite smoke test for PHPX sqlite module.
Mode:
- Default: prints SKIP unless PHPX_DB_SMOKE=1.
- Smoke: when enabled, uses async default APIs and verifies row count.
*/
import { connect, exec, query, close } from 'db/sqlite'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$path = getenv('SQLITE_PATH') ?: '/tmp/deka_phpx_async_smoke.sqlite'

$conn = await connect({ path: $path })
if (!result_is_ok($conn)) {
    echo "ERR connect\n"
    return
}

$handle = $conn->value
$create = await exec($handle, 'create table if not exists async_smoke_items(id integer primary key, name text)', [])
if (!result_is_ok($create)) {
    await close($handle)
    echo "ERR exec\n"
    return
}

$insert = await exec($handle, 'insert into async_smoke_items(name) values (?)', ['ok'])
if (!result_is_ok($insert)) {
    await close($handle)
    echo "ERR exec\n"
    return
}

$rows = await query($handle, 'select count(*) as c from async_smoke_items', [])
await close($handle)

if (!result_is_ok($rows)) {
    echo "ERR query\n"
    return
}

$count = 0
if (is_array($rows->value) && array_key_exists('rows', $rows->value) && count($rows->value['rows']) > 0) {
    $first = $rows->value['rows'][0]
    if (is_array($first) && array_key_exists('c', $first)) {
        $count = (int) $first['c']
    }
}

echo "OK " . $count . "\n"
