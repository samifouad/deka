/*
TEST: db stats reports active handles and sqlite query metrics.
*/
import { open_handle, query_one, closeSync, statsSync } from 'db'
import { result_is_ok } from 'core/result'

$path = '/tmp/deka_phpx_stats.sqlite'
$open = open_handle('sqlite', { path: $path })
if (!result_is_ok($open)) {
    echo "ERR open\n"
    return
}

$h = $open->value
$q = query_one($h, 'select 1 as v', [])
if (!result_is_ok($q)) {
    closeSync($h)
    echo "ERR query\n"
    return
}

$s = statsSync()
if (!result_is_ok($s)) {
    closeSync($h)
    echo "ERR stats\n"
    return
}

$active = $s->value['active_handles']
$cacheEntries = array_key_exists('statement_cache_entries', $s->value) ? $s->value['statement_cache_entries'] : -1
$cacheHits = array_key_exists('statement_cache_hits', $s->value) ? $s->value['statement_cache_hits'] : -1
$cacheMisses = array_key_exists('statement_cache_misses', $s->value) ? $s->value['statement_cache_misses'] : -1
$metrics = $s->value['metrics']
if (!is_int($active) || $active < 1) {
    closeSync($h)
    echo "ERR active\n"
    return
}

if (!is_int($cacheEntries) || !is_int($cacheHits) || !is_int($cacheMisses)) {
    closeSync($h)
    echo "ERR cache-metrics\n"
    return
}

if (!is_array($metrics) || !array_key_exists('query:sqlite', $metrics)) {
    closeSync($h)
    echo "ERR metric-key\n"
    return
}

$bucket = $metrics['query:sqlite']
if (!is_array($bucket) || !array_key_exists('calls', $bucket) || $bucket['calls'] < 1) {
    closeSync($h)
    echo "ERR metric-calls\n"
    return
}

closeSync($h)
echo "OK stats\n"
