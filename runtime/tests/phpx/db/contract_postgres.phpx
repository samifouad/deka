/*
TEST: db facade contract for postgres wrapper (connectSync/querySync/query_one/closeSync)
*/
import { connectSync, querySync, query_one, closeSync } from 'db/postgres'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$host = getenv('DB_HOST') ?: '127.0.0.1'
$port = intval(getenv('DB_PORT') ?: '55432')
$database = getenv('DB_NAME') ?: 'linkhash_registry'
$user = getenv('DB_USER') ?: 'postgres'
$password = getenv('DB_PASSWORD') ?: 'postgres'

$conn = connectSync({ host: $host, port: $port, database: $database, user: $user, password: $password })
if (!result_is_ok($conn)) {
    echo "ERR connectSync\n"
    return
}

$h = $conn->value
$many = querySync($h, 'select count(*) as c from packages', [])
$one = query_one($h, 'select count(*) as c from packages', [])
$sum = query_one($h, 'select $1::int + $2::int as s', [2, 3])
closeSync($h)

if (!result_is_ok($many) || !result_is_ok($one) || !result_is_ok($sum)) {
    echo "ERR querySync\n"
    return
}

if (intval($sum->value['s']) !== 5) {
    echo "ERR querySync\n"
    return
}

echo "OK postgres " . $one->value['c'] . "\n"
