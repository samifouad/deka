/*
TEST: db facade contract for sqlite wrapper (open_handle/querySync/query_one/closeSync)
*/
import { connectSync, execSync, querySync, query_one, closeSync } from 'db/sqlite'
import { affected_rows } from 'db'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$path = getenv('SQLITE_PATH') ?: '/tmp/deka_phpx_contract.sqlite'
$conn = connectSync({ path: $path })
if (!result_is_ok($conn)) {
    echo "ERR connectSync\n"
    return
}

$h = $conn->value

$create = execSync($h, 'create table if not exists contract_items(id integer primary key, name text)', [])
if (!result_is_ok($create)) {
    closeSync($h)
    echo "ERR create\n"
    return
}

$insert = execSync($h, 'insert into contract_items(name) values (?)', ['item'])
$affected = affected_rows($insert)
if (!result_is_ok($insert) || !result_is_ok($affected)) {
    closeSync($h)
    echo "ERR insert\n"
    return
}

$many = querySync($h, 'select count(*) as c from contract_items', [])
$one = query_one($h, 'select count(*) as c from contract_items', [])
$lookup = query_one($h, 'select name from contract_items where name = ?', 'item')
closeSync($h)

if (!result_is_ok($many) || !result_is_ok($one) || !result_is_ok($lookup)) {
    echo "ERR querySync\n"
    return
}

echo "OK sqlite " . $affected->value . " " . $one->value['c'] . "\n"
