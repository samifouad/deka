/*
TEST: SQLite smoke test for PHPX sqlite module.
Mode:
- Default: prints SKIP unless PHPX_DB_SMOKE=1.
- Smoke: when enabled, opens a sqlite file, writes row, then reads count.
*/
import { connectSync, execSync, querySync, closeSync } from 'db/sqlite'
import { result_is_ok } from 'core/result'

if (getenv('PHPX_DB_SMOKE') !== '1') {
    echo "SKIP\n"
    return
}

$path = getenv('SQLITE_PATH') ?: '/tmp/deka_phpx_smoke.sqlite'

$conn = connectSync({
    path: $path
})

if (!result_is_ok($conn)) {
    echo "ERR connectSync\n"
    return
}

$handle = $conn->value
$create = execSync($handle, 'create table if not exists smoke_items(id integer primary key, name text)', [])
if (!result_is_ok($create)) {
    closeSync($handle)
    echo "ERR execSync\n"
    return
}

$insert = execSync($handle, 'insert into smoke_items(name) values (?)', ['ok'])
if (!result_is_ok($insert)) {
    closeSync($handle)
    echo "ERR execSync\n"
    return
}

$rows = querySync($handle, 'select count(*) as c from smoke_items', [])
closeSync($handle)

if (!result_is_ok($rows)) {
    echo "ERR querySync\n"
    return
}

$count = 0
if (is_array($rows->value) && array_key_exists('rows', $rows->value) && count($rows->value['rows']) > 0) {
    $first = $rows->value['rows'][0]
    if (is_array($first) && array_key_exists('c', $first)) {
        $count = (int) $first['c']
    }
}

echo "OK " . $count . "\n"
