/*
TEST: jwt claim validation enforces iat, nbf, exp timing
Covers: iat future rejection, nbf future rejection, exp rejection.
*/

import { sign, verify } from 'jwt'
import { result_is_ok } from 'core/result'

$now = time()

$futureIat = sign([ 'sub' => 'sam', 'iat' => $now + 120 ], 'secret', [])
if (!result_is_ok($futureIat)) {
  echo 'sign_err:' . $futureIat->error . "\n"
  return
}
$futureIatVerify = verify($futureIat->value, 'secret', [])
echo $futureIatVerify->error . "\n"

$futureNbf = sign([ 'sub' => 'sam', 'nbf' => $now + 120 ], 'secret', [])
if (!result_is_ok($futureNbf)) {
  echo 'sign_err:' . $futureNbf->error . "\n"
  return
}
$futureNbfVerify = verify($futureNbf->value, 'secret', [])
echo $futureNbfVerify->error . "\n"

$expired = sign([ 'sub' => 'sam', 'exp' => $now - 1 ], 'secret', [])
if (!result_is_ok($expired)) {
  echo 'sign_err:' . $expired->error . "\n"
  return
}
$expiredVerify = verify($expired->value, 'secret', [])
echo $expiredVerify->error . "\n"
