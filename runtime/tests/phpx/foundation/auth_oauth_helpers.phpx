/*
TEST: auth oauth helper behavior
Covers: PKCE pair generation, state/nonce generation, signed state token validation.
*/

import { result_is_ok } from 'core/result'
import { pkce_pair, new_state, new_nonce, sign_oauth_state, verify_oauth_state } from 'auth'

$pkce = pkce_pair()
echo (result_is_ok($pkce) && $pkce->value.method === 'S256' ? 'pkce-ok' : 'pkce-bad') . "\n"

$state_res = new_state()
$nonce_res = new_nonce()
echo (result_is_ok($state_res) && strlen($state_res->value) > 8 ? 'state-ok' : 'state-bad') . "\n"
echo (result_is_ok($nonce_res) && strlen($nonce_res->value) > 8 ? 'nonce-ok' : 'nonce-bad') . "\n"

$secret = 'linkhash-dev-secret'
$token_res = sign_oauth_state($state_res->value, $nonce_res->value, $secret, 120, [ 'iss' => 'linkhash' ])
if (!result_is_ok($token_res)) {
  echo "token-bad\n"
  return
}
$token = $token_res->value

$verify_ok = verify_oauth_state($token, $secret, $state_res->value, $nonce_res->value, [ 'iss' => 'linkhash' ])
echo (result_is_ok($verify_ok) ? 'verify-ok' : 'verify-bad') . "\n"

$verify_bad = verify_oauth_state($token, $secret, $state_res->value . 'x', $nonce_res->value, [ 'iss' => 'linkhash' ])
echo (!result_is_ok($verify_bad) ? 'tamper-ok' : 'tamper-bad') . "\n"
