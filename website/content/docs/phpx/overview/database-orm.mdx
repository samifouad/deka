---
title: "Database and ORM Flow"
description: "How PHPX apps talk to databases and where generated ORM client code fits."
section: "phpx"
category: "overview"
categoryLabel: "Overview"
categoryOrder: 0
---

PHPX database access is module-driven.
You import DB modules directly, then move to generated ORM client APIs when your schema is ready.

## Required First Step: `deka.json`

Before running any `deka db ...` command, define DB engine + location in project root `deka.json`.

```json
{
  "db": {
    "engine": "sqlite",
    "location": "./deka.sqlite"
  },
  "scripts": {
    "db": "deka db generate && deka db migrate"
  }
}
```

Or Postgres:

```json
{
  "db": {
    "engine": "postgres",
    "location": "postgres://user:pass@127.0.0.1:5432/app_db"
  },
  "scripts": {
    "db": "deka db generate && deka db migrate"
  }
}
```

Run full setup with:

```bash
deka run db
```

Command behavior:
- `deka db migrate` applies migrations using `db.engine` + `db.location`.
- `deka db flush` resets and reapplies migrations for that engine.
- `deka db info` reports engine/location + migration status for that engine.

If `db` is omitted, CLI falls back to Postgres defaults / `DATABASE_URL`.

## Direct DB module example

```phpx
import { connect } from "db/postgres"

$db = connect({
  host: "127.0.0.1",
  port: 5432,
  user: "postgres",
  password: "postgres",
  database: "linkhash_registry"
})

$rows = $db.query("select 1 as n")
echo $rows[0].n
```

Expected output:

```text
1
```

## Parameterized query example

```phpx
$rows = $db.query(
  "select name, downloads from packages where downloads > $1 order by downloads desc limit $2",
  [1000, 5]
)

echo $rows[0].name
```

Expected behavior:

```text
Returns top package names over the threshold as native PHPX values.
```

## ORM workflow (high-level)

1. Define typed models (struct/interface based)
2. Generate client: `deka db generate <model-file-or-dir>`
3. Run migrations: `deka db migrate`
4. Import generated client from `@/db`

Example generated usage:

```phpx
import { db } from "@/db"

$packages = db.package.findMany({
  where: { visibility: "public" },
  orderBy: { downloads: "desc" },
  limit: 20
})
```

## Write example

```phpx
$created = db.package.create({
  data: {
    name: "component",
    owner: "@samifou.ad",
    visibility: "public"
  }
})

echo $created.name
```

Expected output:

```text
component
```

This keeps the same typed DX across app code and persistence logic.
