---
title: /auth (Servicio de Identidad)
description: API de autenticación y gestión de sesiones orientada a móviles
---
El Servicio de Identidad proporciona autenticación segura para las aplicaciones de Tana utilizando autenticación con código QR móvil primero (similar a WhatsApp Web). Las claves privadas permanecen exclusivamente en los dispositivos móviles, mientras que las computadoras de escritorio/portátiles solo reciben tokens de sesión.

**URL Base:** `http://localhost:8090` (desarrollo) o `https://auth.tana.network` (producción)

**Conceptos Clave:**
- **Autenticación basada en sesión** - Sin claves privadas en escritorio/portátil
- **Inicio de sesión con código QR** - La aplicación móvil escanea el QR del sitio web
- **Eventos Enviados por el Servidor (SSE)** - Actualizaciones de estado de sesión en tiempo real
- **Firmas Ed25519** - Prueba criptográfica de propiedad
- **Seguridad de hardware** - Claves privadas protegidas por el enclave seguro del dispositivo móvil

---

## Flujo de Autenticación

```
1. Website → POST /auth/session/create
   Returns: sessionId, challenge, QR data

2. Website → GET /auth/session/:id/events (SSE)
   Streams: Real-time session status updates

3. Mobile App → GET /auth/session/:id
   Returns: Session details, marks as "scanned"

4. User approves on mobile

5. Mobile App → POST /auth/session/:id/approve
   Body: Signed challenge with Ed25519

6. SSE → "approved" event to website
   Includes: sessionToken for authenticated requests

7. Website uses sessionToken for subsequent API calls
```

---

<details>
 <summary><code className="text-green-400">POST</code> <code><b>/auth/session/create</b></code> <code>(crear sesión de inicio de sesión QR)</code></summary>

### Solicitud

```bash
curl -X POST http://localhost:8090/auth/session/create \
  -H "Content-Type: application/json" \
  -d '{
    "returnUrl": "http://localhost:3000/dashboard",
    "appName": "My Tana App",
    "appIcon": "https://example.com/icon.png"
  }'
```

### Parámetros

<table>
 <tr>
    <td>_parámetro_</td>
    <td>_tipo_</td>
    <td>_necesidad_</td>
  </tr>
 <tr>
    <td>**returnUrl**</td>
    <td>cadena (URL)</td>
    <td>requerido</td>
  </tr>
 <tr>
    <td>**appName**</td>
    <td>cadena</td>
    <td>opcional</td>
  </tr>
 <tr>
    <td>**appIcon**</td>
    <td>cadena (URL)</td>
    <td>opcional</td>
  </tr>
</table>

### Respuesta

```json
{
  "sessionId": "sess_3ogy2lnxi0fl4rlz",
  "challenge": "auth_chal_b92f3aed...",
  "expiresAt": 1762915859863,
  "expiresIn": 300,
  "qrData": "{\"sessionId\":\"sess_...\",\"challenge\":\"auth_chal_...\",\"service\":\"tana-identity\"}"
}
```

**Estado:** `201 Created`

**Caso de Uso:** El sitio web inicia el flujo de inicio de sesión creando una sesión y mostrando el código QR

</details>

---

<details>
 <summary><code className="text-cyan-400">GET</code> <code><b>/auth/session/:id/events</b></code> <code>(stream SSE para actualizaciones en tiempo real)</code></summary>

### Solicitud

```bash
curl -N http://localhost:8090/auth/session/sess_abc123/events
```

### Eventos Enviados por el Servidor

**Evento de conexión:**
```json
event: connected
data: {"type":"connected","sessionId":"sess_abc123"}
```

**Evento de actualización de estado:**
```json
event: status
data: {"type":"status","status":"waiting","scannedAt":null,"approvedAt":null}
```

**Evento escaneado:**
```json
event: status
data: {"type":"status","status":"scanned","scannedAt":"2025-01-11T19:00:00.000Z","approvedAt":null}
```

**Evento aprobado (terminal):**
```json
event: approved
data: {
  "type":"approved",
  "sessionToken":"tana_session_abc123...",
  "userId":"usr_alice",
  "username":"@alice",
  "returnUrl":"http://localhost:3000/dashboard"
}
```

**Evento rechazado (terminal):**
```json
event: rejected
data: {"type":"rejected"}
```

**Evento expirado (terminal):**
```json
event: expired
data: {"type":"expired"}
```

**Estado:** `200 OK` (mantiene la conexión abierta)

**Caso de Uso:** El sitio web abre una conexión SSE para recibir actualizaciones de estado en tiempo real a medida que el usuario escanea/aprueba en el móvil

</details>

---

<details>
 <summary><code className="text-cyan-400">GET</code> <code><b>/auth/session/:id</b></code> <code>(obtener detalles de la sesión)</code></summary>

### Solicitud

```bash
curl http://localhost:8090/auth/session/sess_abc123
```

### Respuesta

```json
{
  "sessionId": "sess_abc123",
  "challenge": "auth_chal_b92f3aed...",
  "status": "waiting",
  "appName": "My Tana App",
  "appIcon": "https://example.com/icon.png",
  "expiresAt": 1762915859863
}
```

**Estado:** `200 OK`

**Efecto Secundario:** Si el estado de la sesión es "esperando", se marca automáticamente como "escaneado"

**Caso de Uso:** La aplicación móvil escanea el código QR y recupera los detalles de la sesión

</details>

---

<details>
 <summary><code className="text-green-400">POST</code> <code><b>/auth/session/:id/approve</b></code> <code>(aprobar inicio de sesión con firma)</code></summary>

### Solicitud

```bash
curl -X POST http://localhost:8090/auth/session/sess_abc123/approve \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "usr_alice",
    "username": "@alice",
    "publicKey": "ed25519_abc123...",
    "signature": "0x1a2b3c...",
    "message": "I approve this login session: auth_chal_b92f3aed..."
  }'
```

### Parámetros

<table>
 <tr>
    <td>_parámetro_</td>
    <td>_tipo_</td>
    <td>_necesidad_</td>
  </tr>
 <tr>
    <td>**userId**</td>
    <td>cadena (UUID)</td>
    <td>requerido</td>
  </tr>
 <tr>
    <td>**username**</td>
    <td>cadena</td>
    <td>requerido</td>
  </tr>
 <tr>
    <td>**publicKey**</td>
    <td>cadena</td>
    <td>requerido</td>
  </tr>
 <tr>
    <td>**signature**</td>
    <td>cadena (hex)</td>
    <td>requerido</td>
  </tr>
 <tr>
    <td>**message**</td>
    <td>cadena</td>
    <td>requerido</td>
  </tr>
</table>

### Respuesta

```json
{
  "success": true,
  "sessionToken": "tana_session_abc123...",
  "returnUrl": "http://localhost:3000/dashboard"
}
```

**Estado:** `200 OK`

**Validación:**
- La firma Ed25519 debe ser válida para el mensaje y la clave pública proporcionados
- El mensaje debe contener el desafío de la sesión
- La sesión debe estar en estado "esperando" o "escaneado"
- La sesión no debe haber expirado

**Caso de Uso:** El usuario aprueba el inicio de sesión en la aplicación móvil, que firma el desafío con la clave privada

</details>

---

<details>
 <summary><code className="text-green-400">POST</code> <code><b>/auth/session/:id/reject</b></code> <code>(rechazar inicio de sesión)</code></summary>

### Solicitud

```bash
curl -X POST http://localhost:8090/auth/session/sess_abc123/reject
```

### Respuesta

```json
{
  "success": true
}
```

**Estado:** `200 OK`

**Caso de Uso:** El usuario rechaza el intento de inicio de sesión en la aplicación móvil

</details>

---

<details>
 <summary><code className="text-green-400">POST</code> <code><b>/auth/session/validate</b></code> <code>(validar token de sesión)</code></summary>

### Solicitud

```bash
curl -X POST http://localhost:8090/auth/session/validate \
  -H "Content-Type: application/json" \
  -d '{
    "sessionToken": "tana_session_abc123..."
  }'
```

### Parámetros

<table>
 <tr>
    <td>_parámetro_</td>
    <td>_tipo_</td>
    <td>_necesidad_</td>
  </tr>
 <tr>
    <td>**sessionToken**</td>
    <td>cadena</td>
    <td>requerido</td>
  </tr>
</table>

### Respuesta (Válida)

```json
{
  "valid": true,
  "userId": "usr_alice",
  "username": "@alice"
}
```

**Estado:** `200 OK`

### Respuesta (Inválida)

```json
{
  "error": "Invalid or expired session token"
}
```

**Estado:** `401 Unauthorized`

**Caso de Uso:** Los servicios de backend validan los tokens de sesión de las solicitudes autenticadas

</details>

---

## Modelo de Seguridad

### Aislamiento de Claves Privadas

**✅ SEGURO (Dispositivo Móvil):**
- Claves privadas almacenadas en enclave seguro respaldado por hardware (iOS) / StrongBox (Android)
- Protección biométrica (Face ID, Touch ID, huella digital)
- El sandboxing a nivel de sistema operativo previene la extracción de claves
- Firmas generadas dentro del hardware seguro

**❌ INSEGURO (Escritorio/Portátil):**
- Sin claves privadas - solo tokens de sesión
- Los tokens de sesión son revocables y limitados en el tiempo (30 días)
- Los tokens proporcionan acceso de solo lectura a la blockchain
- Las computadoras de escritorio son más vulnerables al malware

### ¿Por Qué No Extensiones de Navegador?

Tana rechaza explícitamente el modelo de MetaMask/extensión de navegador:

1. **Riesgo de Malware** - Las computadoras de escritorio son objetivos principales de malware
2. **Vulnerabilidades del Navegador** - Las extensiones tienen permisos amplios
3. **Extracción de Claves** - El almacenamiento de claves basado en software puede ser comprometido
4. **Comportamiento del Usuario** - Los usuarios instalan muchas extensiones de fuentes no confiables

### Ventajas Móvil Primero

1. **Seguridad de Hardware** - El enclave seguro protege las claves a nivel de hardware
2. **Autenticación Biométrica** - Face ID/Touch ID para cada transacción
3. **Superficie de Ataque Más Pequeña** - Sandboxing de aplicaciones iOS/Android
4. **Conciencia del Usuario** - La aprobación móvil hace que cada acción sea explícita
5. **Prevención de Pérdida** - Los dispositivos pueden ser borrados de forma remota

### Seguridad del Flujo de Autenticación

1. **Desafío-Respuesta** - Desafío aleatorio previene ataques de repetición
2. **Firmas Ed25519** - Prueba criptográfica de propiedad
3. **Límites de Tiempo** - Las sesiones expiran después de 5 minutos (inicio de sesión) o 30 días (token)
4. **Seguimiento de Estado** - Máquina de estados "esperando" → "escaneado" → "aprobado"
5. **Actualizaciones SSE** - Retroalimentación en tiempo real sin sondeo

## Ciclo de Vida de la Sesión

**Estados de Sesión:**
- `waiting` - Código QR mostrado, esperando escaneo móvil
- `scanned` - La aplicación móvil ha recuperado los detalles de la sesión
- `approved` - Usuario aprobado y firma verificada → token generado
- `rejected` - Usuario rechazó el intento de inicio de sesión
- `expired` - La sesión ha expirado (5 minutos)

**Ciclo de Vida del Token de Sesión:**
- Generado después de la aprobación con verificación de firma Ed25519
- Expira 30 días después de la aprobación
- Puede ser revocado en cualquier momento
- Utilizado para solicitudes API autenticadas subsiguientes

## Respuestas de Error

**404 No Encontrado:**
```json
{
  "error": "Session not found"
}
```

**400 Solicitud Incorrecta:**
```json
{
  "error": "Invalid signature"
}
```

```json
{
  "error": "Challenge mismatch"
}
```

```json
{
  "error": "Session expired"
}
```

**401 No Autorizado:**
```json
{
  "error": "Invalid or expired session token"
}
```

**500 Error Interno del Servidor:**
```json
{
  "error": "Failed to create session"
}
```

## Documentación Relacionada

- [Protocolo de Autenticación Móvil](/docs/MOBILE_AUTH_PROTOCOL.md) - Especificación detallada del protocolo
- [Guía de Firma de Transacciones](/guides/transaction-signing/) - Cómo funcionan las firmas Ed25519
- [Variables de Entorno](/contributing/env-vars/) - Configurar `IDENTITY_DB_URL` y `IDENTITY_PORT`
- [Arquitectura](/contributing/architecture/) - Servicio de identidad en el diseño del sistema
